select top 100 S_STORE_NAME,
      sum(SS_NET_PROFIT)
from store_sales,
      date_dim,
      store,
      (
            select CA_ZIP
            from (
                        SELECT substring(CA_ZIP, 1, 5) CA_ZIP
                        FROM customer_address
                        WHERE substring(CA_ZIP, 1, 5) IN (
                                    '38895',
                                    '45237',
                                    '37195',
                                    '17703',
                                    '32727',
                                    '20327',
                                    '61691',
                                    '65515',
                                    '56607',
                                    '68993',
                                    '27131',
                                    '46701',
                                    '28953',
                                    '22995',
                                    '56371',
                                    '61315',
                                    '70887',
                                    '48327',
                                    '26059',
                                    '34823',
                                    '39953',
                                    '17369',
                                    '90503',
                                    '53329',
                                    '12707',
                                    '84825',
                                    '14879',
                                    '32845',
                                    '64751',
                                    '57665',
                                    '77365',
                                    '21105',
                                    '46087',
                                    '72369',
                                    '72959',
                                    '75121',
                                    '55075',
                                    '80799',
                                    '79295',
                                    '48317',
                                    '90809',
                                    '89303',
                                    '26921',
                                    '48897',
                                    '32183',
                                    '23915',
                                    '16607',
                                    '15199',
                                    '68743',
                                    '58877',
                                    '65621',
                                    '79115',
                                    '66487',
                                    '29161',
                                    '99933',
                                    '62891',
                                    '85665',
                                    '84565',
                                    '72699',
                                    '14591',
                                    '45789',
                                    '30717',
                                    '72245',
                                    '65331',
                                    '41351',
                                    '37385',
                                    '55643',
                                    '72595',
                                    '26365',
                                    '53099',
                                    '23305',
                                    '16943',
                                    '14045',
                                    '14709',
                                    '43539',
                                    '49745',
                                    '73835',
                                    '99031',
                                    '16685',
                                    '80027',
                                    '95099',
                                    '27803',
                                    '14609',
                                    '42705',
                                    '69495',
                                    '40319',
                                    '76201',
                                    '32113',
                                    '43305',
                                    '24871',
                                    '42919',
                                    '57219',
                                    '81785',
                                    '89797',
                                    '46167',
                                    '25195',
                                    '34365',
                                    '24383',
                                    '84881',
                                    '31103',
                                    '77465',
                                    '27357',
                                    '31377',
                                    '86743',
                                    '63189',
                                    '33057',
                                    '90641',
                                    '41891',
                                    '29989',
                                    '19305',
                                    '93099',
                                    '86267',
                                    '59033',
                                    '20815',
                                    '77029',
                                    '84727',
                                    '37783',
                                    '46663',
                                    '33811',
                                    '22927',
                                    '70197',
                                    '87717',
                                    '56871',
                                    '17623',
                                    '46343',
                                    '13133',
                                    '70075',
                                    '62781',
                                    '37177',
                                    '72891',
                                    '36087',
                                    '58615',
                                    '73839',
                                    '45713',
                                    '77495',
                                    '70539',
                                    '17603',
                                    '24021',
                                    '19369',
                                    '22021',
                                    '85043',
                                    '28517',
                                    '88187',
                                    '30945',
                                    '22477',
                                    '47007',
                                    '23025',
                                    '91557',
                                    '61013',
                                    '34913',
                                    '31511',
                                    '46609',
                                    '28633',
                                    '82269',
                                    '11779',
                                    '16573',
                                    '35113',
                                    '21717',
                                    '44669',
                                    '98787',
                                    '50511',
                                    '30985',
                                    '33647',
                                    '82631',
                                    '33707',
                                    '39681',
                                    '70017',
                                    '71491',
                                    '44495',
                                    '30767',
                                    '20425',
                                    '92071',
                                    '66777',
                                    '85639',
                                    '83257',
                                    '29093',
                                    '31227',
                                    '29121',
                                    '39713',
                                    '92819',
                                    '98359',
                                    '86979',
                                    '46829',
                                    '55875',
                                    '90965',
                                    '15315',
                                    '11491',
                                    '45403',
                                    '45091',
                                    '71507',
                                    '14843',
                                    '61621',
                                    '45589',
                                    '14211',
                                    '37703',
                                    '89193',
                                    '81389',
                                    '67133',
                                    '87669',
                                    '37011',
                                    '85337',
                                    '69779',
                                    '58691',
                                    '87317',
                                    '15189',
                                    '78877',
                                    '26703',
                                    '60397',
                                    '48943',
                                    '91159',
                                    '11653',
                                    '47455',
                                    '62061',
                                    '11263',
                                    '72873',
                                    '97413',
                                    '85973',
                                    '34679',
                                    '28913',
                                    '83053',
                                    '20617',
                                    '28143',
                                    '72411',
                                    '98055',
                                    '30703',
                                    '41685',
                                    '59415',
                                    '83687',
                                    '70449',
                                    '22313',
                                    '85169',
                                    '17169',
                                    '62505',
                                    '35323',
                                    '67757',
                                    '87977',
                                    '73073',
                                    '88203',
                                    '21817',
                                    '19213',
                                    '15493',
                                    '28725',
                                    '81475',
                                    '45647',
                                    '53873',
                                    '76235',
                                    '77921',
                                    '11317',
                                    '34453',
                                    '86861',
                                    '66665',
                                    '36143',
                                    '29773',
                                    '77557',
                                    '23823',
                                    '65031',
                                    '40073',
                                    '39405',
                                    '72383',
                                    '45337',
                                    '58241',
                                    '75431',
                                    '89379',
                                    '27595',
                                    '39951',
                                    '53249',
                                    '49053',
                                    '79689',
                                    '38129',
                                    '75095',
                                    '55489',
                                    '13427',
                                    '49927',
                                    '50845',
                                    '46421',
                                    '30605',
                                    '59247',
                                    '70455',
                                    '25147',
                                    '95729',
                                    '10569',
                                    '92803',
                                    '38993',
                                    '27935',
                                    '94759',
                                    '46777',
                                    '49181',
                                    '57971',
                                    '48063',
                                    '51775',
                                    '92105',
                                    '84965',
                                    '73953',
                                    '77213',
                                    '12387',
                                    '58419',
                                    '36553',
                                    '22143',
                                    '31893',
                                    '54017',
                                    '38129',
                                    '82805',
                                    '44699',
                                    '78173',
                                    '11879',
                                    '69237',
                                    '87585',
                                    '59973',
                                    '20299',
                                    '37949',
                                    '41559',
                                    '15075',
                                    '97495',
                                    '17653',
                                    '72463',
                                    '49505',
                                    '71621',
                                    '76143',
                                    '64101',
                                    '85271',
                                    '81823',
                                    '69635',
                                    '48655',
                                    '54077',
                                    '75387',
                                    '31667',
                                    '42667',
                                    '37723',
                                    '23643',
                                    '26917',
                                    '62235',
                                    '82187',
                                    '54231',
                                    '61793',
                                    '96491',
                                    '18461',
                                    '59433',
                                    '22471',
                                    '14893',
                                    '46151',
                                    '88943',
                                    '50291',
                                    '71105',
                                    '36751',
                                    '30827',
                                    '83443',
                                    '49201',
                                    '12835',
                                    '49311',
                                    '75519',
                                    '67719',
                                    '78731',
                                    '16619',
                                    '62889',
                                    '25883',
                                    '49355',
                                    '49713',
                                    '45305',
                                    '23863',
                                    '64559',
                                    '63947',
                                    '41001',
                                    '50321',
                                    '58907',
                                    '74633',
                                    '57445',
                                    '17981',
                                    '71649',
                                    '63303',
                                    '26211',
                                    '42223',
                                    '14755',
                                    '23949',
                                    '89871',
                                    '57333',
                                    '13201',
                                    '59447',
                                    '94397',
                                    '77615',
                                    '21199',
                                    '59925',
                                    '82709',
                                    '35977',
                                    '77983',
                                    '64159',
                                    '93255',
                                    '15039',
                                    '51335',
                                    '97291',
                                    '61875',
                                    '93667',
                                    '14377',
                                    '14153',
                                    '35265',
                                    '41571',
                                    '73761',
                                    '89685',
                                    '25213',
                                    '42401',
                                    '40879'
                              )
                        intersect
                        select CA_ZIP
                        from (
                                    SELECT substring(CA_ZIP, 1, 5) CA_ZIP,
                                          count(*) cnt
                                    FROM customer_address,
                                          customer
                                    WHERE CA_ADDRESS_SK = C_CURRENT_ADDR_SK
                                          and C_PREFERRED_CUST_FLAG = 'Y'
                                    group by CA_ZIP
                                    having count(*) > 10
                              ) A1
                  ) A2
      ) V1
where SS_STORE_SK = S_STORE_SK
      and SS_SOLD_DATE_SK = D_DATE_SK
      and D_QOY = 2
      and D_YEAR = 2000
      and (substring(S_ZIP, 1, 2) = substring(V1.CA_ZIP, 1, 2))
group by S_STORE_NAME
order by S_STORE_NAME option (label = 'TPCDS-Q8');